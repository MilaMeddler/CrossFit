<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Administration</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900">

<!-- TOP MENU -->
<div class="bg-white shadow mb-6">
    <div class="max-w-6xl mx-auto px-4 py-3 flex gap-6 text-lg font-semibold">
        <button class="menu-tab text-blue-600" data-tab="athletes">Athlètes</button>
        <button class="menu-tab" data-tab="tournaments">Tournois</button>
    </div>
</div>

<div class="max-w-6xl mx-auto px-4 pb-24">

    <!-- ======================== ATHLETES TAB ======================== -->
    <div id="tab-athletes" class="tab-section">

        <h2 class="text-2xl font-bold mb-4">Athlètes (Globaux)</h2>

        <!-- Add athlete -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold mb-3">Ajouter un athlète</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="ath-first" class="border p-2 rounded" placeholder="Prénom">
                <input id="ath-last" class="border p-2 rounded" placeholder="Nom">
                <select id="ath-gender" class="border p-2 rounded">
                    <option value="M">Homme</option>
                    <option value="F">Femme</option>
                </select>
                <input id="ath-birth" type="date" class="border p-2 rounded">
                <select id="ath-level" class="border p-2 rounded">
                    <option value="RX">RX</option>
                    <option value="INTER">INTER</option>
                    <option value="SCALE">SCALE</option>
                </select>
                <input id="ath-team" class="border p-2 rounded" placeholder="Équipe (optionnel)">
            </div>

            <button id="btn-add-ath" class="mt-3 bg-green-600 text-white px-4 py-2 rounded">
                Ajouter
            </button>
        </div>

        <!-- Athletes table -->
        <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-3">Liste des athlètes</h3>

            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="athletes-table">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="p-2 text-left">Nom</th>
                        <th class="p-2 text-left">Level</th>
                        <th class="p-2 text-left">Sexe</th>
                        <th class="p-2 text-left">Naissance</th>
                        <th class="p-2 text-center">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="athletes-list"></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- ======================== TOURNAMENTS TAB ======================== -->
    <div id="tab-tournaments" class="tab-section hidden">

        <h2 class="text-2xl font-bold mb-4">Tournois</h2>

        <!-- Tournament selector -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <div class="flex gap-4">
                <select id="tournament-select" class="border p-2 rounded flex-1"></select>
                <button id="btn-new-tournament" class="bg-blue-600 text-white px-4 py-2 rounded">
                    Nouveau tournoi
                </button>
                <button id="btn-refresh" class="bg-gray-200 px-4 py-2 rounded">
                    Rafraîchir
                </button>
            </div>
        </div>

        <!-- WOD MANAGEMENT -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold mb-3">Ajouter un WOD</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="wod-number" type="number" class="border p-2 rounded" placeholder="Numéro WOD">

                <select id="wod-type" class="border p-2 rounded">
                    <option value="time">For Time</option>
                    <option value="reps">AMRAP</option>
                    <option value="weight">Weight</option>
                    <option value="complex">Complex</option>
                </select>

                <textarea id="wod-desc" class="border p-2 rounded md:col-span-3" placeholder="Description du WOD"></textarea>
            </div>

            <button id="btn-add-wod" class="mt-3 bg-green-600 text-white px-4 py-2 rounded">
                Ajouter WOD
            </button>
        </div>

        <!-- WOD table -->
        <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-3">WOD du tournoi</h3>

            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="wods-table">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="p-2 text-left">N°</th>
                        <th class="p-2 text-left">Type</th>
                        <th class="p-2 text-left">Description</th>
                        <th class="p-2 text-center">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="wods-list"></tbody>
                </table>
            </div>
        </div>

        <!-- RESULTS -->
        <div class="bg-white p-4 rounded shadow mt-6">
            <h3 class="font-bold mb-3">Résultats récents</h3>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="p-2 text-left">Athlète</th>
                        <th class="p-2 text-left">WOD</th>
                        <th class="p-2 text-left">Résultat</th>
                        <th class="p-2 text-center">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="results-list"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Status bubble -->
<div id="status"
     class="fixed right-3 bottom-3 bg-black text-white px-4 py-2 rounded shadow text-sm hidden"></div>


<!-- CONFIG & API -->
<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/api.js"></script>

<script>
/* ---------------------- MENU LOGIC ---------------------- */
document.querySelectorAll('.menu-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.menu-tab').forEach(b => b.classList.remove('text-blue-600'));
        btn.classList.add('text-blue-600');

        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
    });
});


/* ---------------------- STATUS ---------------------- */
function showStatus(text, timeout = 2500) {
    const s = document.getElementById('status');
    s.textContent = text;
    s.classList.remove('hidden');
    setTimeout(() => s.classList.add('hidden'), timeout);
}


/* ---------------------- GLOBAL VARS ---------------------- */
let currentTournamentId = null;
let tournaments = [];


/* ---------------------- LOAD TOURNAMENTS ---------------------- */
async function loadTournaments() {
    const sel = document.getElementById('tournament-select');
    sel.innerHTML = '';

    tournaments = await api.getTournaments();

    tournaments.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
    });

    if (tournaments.length) {
        currentTournamentId = tournaments[0].id;
        sel.value = currentTournamentId;
        await loadTournamentData();
    }
}


/* ---------------------- LOAD DATA FOR SELECTED TOURNAMENT ---------------------- */
async function loadTournamentData() {
    if (!currentTournamentId) return;

    const data = await api.getAllData(currentTournamentId);
    window._data = data;

    renderWODs(data.workouts);
    renderResults(data.results);
}


/* ---------------------- ATHLETES ---------------------- */
async function loadAthletes() {
    const athletes = await api.getGlobalAthletes();  
    renderAthletes(athletes);
}

document.getElementById('btn-add-ath').addEventListener('click', async () => {
    const first = ath-first.value.trim();
    const last = ath-last.value.trim();

    if (!first || !last) {
        alert("Nom requis");
        return;
    }

    await api.addGlobalAthlete({
        first_name: first,
        last_name: last,
        gender: ath-gender.value,
        birthdate: ath-birth.value || null,
        level: ath-level.value,
        team: ath-team.value || null
    });

    showStatus("Athlète ajouté");
    await loadAthletes();
});

function renderAthletes(list) {
    const tbody = document.getElementById('athletes-list');
    if (!list.length) {
        tbody.innerHTML = `<tr><td class="p-2" colspan="5">Aucun athlète</td></tr>`;
        return;
    }

    tbody.innerHTML = list.map(a => `
        <tr class="border-t">
            <td class="p-2">${a.first_name} ${a.last_name}</td>
            <td class="p-2">${a.level}</td>
            <td class="p-2">${a.gender}</td>
            <td class="p-2">${a.birthdate ? new Date(a.birthdate).toLocaleDateString() : "-"}</td>
            <td class="p-2 text-center">
                <button onclick="deleteAthlete(${a.id})" class="text-red-600">Supprimer</button>
            </td>
        </tr>
    `).join('');
}

async function deleteAthlete(id) {
    if (!confirm("Supprimer ?")) return;

    await api.deleteGlobalAthlete(id);
    showStatus("Supprimé");
    await loadAthletes();
}


/* ---------------------- WODS ---------------------- */
document.getElementById('btn-new-tournament').addEventListener('click', async () => {
    const name = prompt("Nom du tournoi:");
    if (!name) return;

    const t = await api.addTournament({ name });
    showStatus("Tournoi créé");
    await loadTournaments();
    tournament-select.value = t.id;
    currentTournamentId = t.id;
    await loadTournamentData();
});

tournament-select.addEventListener('change', async e => {
    currentTournamentId = Number(e.target.value);
    await loadTournamentData();
});

btn-add-wod.addEventListener('click', async () => {
    if (!currentTournamentId) return alert("Choisir un tournoi");

    await api.addWorkout({
        tournament_id: currentTournamentId,
        wod_number: Number(wod-number.value),
        wod_type: wod-type.value,
        description: wod-desc.value.trim()
    });

    showStatus("WOD ajouté");
    wod-number.value = "";
    wod-desc.value = "";
    await loadTournamentData();
});

function renderWODs(list) {
    const tbody = document.getElementById('wods-list');

    if (!list.length) {
        tbody.innerHTML = `<tr><td class="p-2" colspan="4">Aucun WOD</td></tr>`;
        return;
    }

    const mapType = {
        "time": "For Time",
        "reps": "AMRAP",
        "weight": "Weight",
        "complex": "Complex"
    };

    tbody.innerHTML = list.map(w => `
        <tr class="border-t">
            <td class="p-2">${w.wod_number}</td>
            <td class="p-2">${mapType[w.wod_type]}</td>
            <td class="p-2">${(w.description || "").slice(0,150)}</td>
            <td class="p-2 text-center">
                <button onclick="deleteWOD(${w.id})" class="text-red-600">Supprimer</button>
            </td>
        </tr>
    `).join('');
}

async function deleteWOD(id) {
    if (!confirm("Supprimer ce WOD ?")) return;
    await api.deleteWorkout(id);
    showStatus("WOD supprimé");
    await loadTournamentData();
}


/* ---------------------- RESULTS ---------------------- */
function renderResults(list) {
    const tbody = document.getElementById('results-list');

    if (!list.length) {
        tbody.innerHTML = `<tr><td class="p-2" colspan="4">Aucun résultat</td></tr>`;
        return;
    }

    const athletes = window._data.athletes;
    const workouts = window._data.workouts;

    tbody.innerHTML = list.slice(-50).reverse().map(r => {
        const a = athletes.find(x => x.id === r.athlete_id);
        const w = workouts.find(x => x.id === r.workout_id);

        const val = r.value_int ?? r.value_time ?? r.value_decimal ?? r.notes ?? "-";

        return `
        <tr class="border-t">
            <td class="p-2">${a ? a.first_name + " " + a.last_name : "-"}</td>
            <td class="p-2">${w ? ("WOD " + w.wod_number) : "-"}</td>
            <td class="p-2">${val}</td>
            <td class="p-2 text-center">
                <button onclick="deleteResult(${r.id})" class="text-red-600">Supprimer</button>
            </td>
        </tr>`;
    }).join('');
}

async function deleteResult(id) {
    if (!confirm("Supprimer ce résultat ?")) return;
    await api.deleteResult(id);
    showStatus("Supprimé");
    await loadTournamentData();
}


/* ---------------------- INIT ---------------------- */
(async function init() {
    if (!window.api) window.api = new CrossFitAPI();
    showStatus("Chargement...");

    await loadAthletes();
    await loadTournaments();

    showStatus("OK", 800);
})();
</script>
</body>
</html>
