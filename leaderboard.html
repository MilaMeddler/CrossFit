<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - CrossFit Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="max-w-7xl mx-auto p-4 md:p-6 pb-24">
    <!-- Header -->
    <div class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">CrossFit Tournament</h1>
        <p class="text-lg text-gray-600">Tableau des Leaders</p>
        <div class="flex justify-center gap-6 mt-4 text-sm">
            <a href="index.html" class="text-gray-600 hover:text-gray-900">Accueil</a>
            <a href="admin.html" class="text-gray-600 hover:text-gray-900">Admin</a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Tournament -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Tournoi</label>
                <select id="tournament-select" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="">Chargement...</option>
                </select>
            </div>

            <!-- Category -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Cat√©gorie</label>
                <select id="category-select" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="all">Tous</option>
                    <option value="RX">RX</option>
                    <option value="INTER">INTER</option>
                    <option value="SCALE">SCALE</option>
                </select>
            </div>

            <!-- Gender -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Genre</label>
                <select id="gender-select" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="all">Tous</option>
                    <option value="M">Hommes</option>
                    <option value="F">Femmes</option>
                </select>
            </div>

            <!-- WOD -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">WOD</label>
                <select id="wod-select" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="overall">Classement G√©n√©ral</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard-container" class="bg-white rounded-lg shadow overflow-hidden">
        <div class="bg-gray-800 text-white p-4">
            <h2 class="text-xl font-bold" id="leaderboard-title">Classement G√©n√©ral</h2>
            <p class="text-sm text-gray-300 mt-1" id="leaderboard-subtitle">Moins de points = Meilleur classement</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b-2 border-gray-300">
                    <tr id="table-header">
                        <!-- Dynamic headers -->
                    </tr>
                </thead>
                <tbody id="leaderboard-tbody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Last Update -->
    <div class="text-center text-gray-500 text-sm mt-6">
        <p>Mise √† jour: <span id="last-update">--:--</span></p>
        <p class="mt-1">Auto-refresh: 10s</p>
    </div>
</div>

<div class="mobile-nav md:hidden">
    <a href="index.html"><span>üè†</span>Accueil</a>
    <a href="admin.html"><span>üë•</span>Admin</a>
    <a href="leaderboard.html" class="active"><span>üèÜ</span>Tableau</a>
</div>

<style>
.mobile-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 2px solid #e5e7eb;
    display: flex;
    justify-content: space-around;
    padding: 0.5rem;
    z-index: 50;
}
.mobile-nav a {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    color: #6b7280;
    text-decoration: none;
    font-size: 0.75rem;
    transition: color 0.2s;
}
.mobile-nav a.active { color: #1f2937; font-weight: 600; }
.mobile-nav a span { font-size: 1.5rem; }

.rank-1 { background-color: #fef3c7; font-weight: 600; }
.rank-2 { background-color: #f3f4f6; font-weight: 600; }
.rank-3 { background-color: #fed7aa; font-weight: 600; }
</style>

<script>
const SUPABASE_URL = 'https://gbdanipvnqrggjjoebtn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdiZGFuaXB2bnFyZ2dqam9lYnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNjYyNzUsImV4cCI6MjA4MDk0MjI3NX0.cRSuKatOSWgcbyhqAJ_5oWnENZK5sQZaZiGL15uytME';

var supabaseLeaderboard;
try {
    supabaseLeaderboard = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
} catch (error) {
    console.error('Failed to create Supabase client:', error);
    alert('Erreur de connexion √† la base de donn√©es');
}

let tournaments = [];
let currentTournamentId = null;
let currentCategory = 'all';
let currentGender = 'all';
let currentWod = 'overall';
let wods = [];
let participants = [];
let scores = [];

// Initialize
async function init() {
    await loadTournaments();
    setupEventListeners();
    startAutoRefresh();
}

function setupEventListeners() {
    document.getElementById('tournament-select').addEventListener('change', async (e) => {
        currentTournamentId = parseInt(e.target.value);
        await loadTournamentData();
    });

    document.getElementById('category-select').addEventListener('change', (e) => {
        currentCategory = e.target.value;
        render();
    });

    document.getElementById('gender-select').addEventListener('change', (e) => {
        currentGender = e.target.value;
        render();
    });

    document.getElementById('wod-select').addEventListener('change', (e) => {
        currentWod = e.target.value;
        render();
    });
}

// Load tournaments
async function loadTournaments() {
    const {data} = await supabaseLeaderboard.from('tournaments').select('*').order('id', {ascending: false});
    tournaments = data || [];

    const select = document.getElementById('tournament-select');
    if (tournaments.length === 0) {
        select.innerHTML = '<option value="">Aucun tournoi</option>';
        return;
    }

    select.innerHTML = tournaments.map(t =>
        `<option value="${t.id}">${t.name} ${t.competition_type === 'team' ? '(√âquipes)' : '(Individuel)'}</option>`
    ).join('');

    currentTournamentId = tournaments[0].id;
    select.value = currentTournamentId;

    await loadTournamentData();
}

// Load data for current tournament
async function loadTournamentData() {
    if (!currentTournamentId) return;

    const tournament = tournaments.find(t => t.id === currentTournamentId);

    // Load WODs
    const {data: wodsData} = await supabaseLeaderboard
        .from('workouts')
        .select('*')
        .eq('tournament_id', currentTournamentId)
        .order('wod_number');
    wods = wodsData || [];

    // Update WOD select
    const wodSelect = document.getElementById('wod-select');
    wodSelect.innerHTML = '<option value="overall">Classement G√©n√©ral</option>' +
        wods.map(w => `<option value="${w.id}">WOD ${w.wod_number}</option>`).join('');

    // Load participants
    if (tournament.competition_type === 'team') {
        const {data: teamsData} = await supabaseLeaderboard
            .from('teams')
            .select(`
                *,
                athlete1:athletes!teams_athlete1_id_fkey(first_name,last_name,gender,level),
                athlete2:athletes!teams_athlete2_id_fkey(first_name,last_name,gender,level)
            `)
            .eq('tournament_id', currentTournamentId);

        participants = (teamsData || []).map(t => ({
            id: `team-${t.id}`,
            teamId: t.id,
            name: t.team_name || `${t.athlete1.first_name} & ${t.athlete2.first_name}`,
            level: t.athlete1.level,
            gender: 'TEAM',
            type: 'team'
        }));
    } else {
        const {data: athletesData} = await supabaseLeaderboard
            .from('athletes')
            .select('*')
            .order('last_name');

        participants = (athletesData || []).map(a => ({
            id: `athlete-${a.id}`,
            athleteId: a.id,
            name: `${a.first_name} ${a.last_name}`,
            level: a.level,
            gender: a.gender,
            type: 'athlete'
        }));
    }

    // Load scores
    const {data: scoresData} = await supabaseLeaderboard
        .from('scores')
        .select(`
            *,
            workouts!inner(id,wod_number,tournament_id)
        `)
        .eq('workouts.tournament_id', currentTournamentId);
    scores = scoresData || [];

    render();
    updateLastUpdate();
}

// Filter participants
function filterParticipants(participants) {
    return participants.filter(p => {
        if (currentCategory !== 'all' && p.level !== currentCategory) return false;
        if (currentGender !== 'all' && p.gender !== currentGender) return false;
        return true;
    });
}

// Calculate rankings
function calculateRankings() {
    const filtered = filterParticipants(participants);
    const rankings = [];

    filtered.forEach(participant => {
        const participantScores = {};
        let totalPoints = 0;

        wods.forEach(wod => {
            const score = scores.find(s => {
                const matchesWod = s.workout_id === wod.id;
                if (participant.type === 'team') {
                    return matchesWod && s.team_id === participant.teamId;
                } else {
                    return matchesWod && s.athlete_id === participant.athleteId;
                }
            });

            const wodScores = scores.filter(s => s.workout_id === wod.id);
            const filteredWodScores = wodScores.filter(s => {
                const scoreParticipant = participants.find(p => {
                    if (p.type === 'team') return s.team_id === p.teamId;
                    return s.athlete_id === p.athleteId;
                });
                return scoreParticipant && filterParticipants([scoreParticipant]).length > 0;
            });

            filteredWodScores.sort((a, b) => {
                const aVal = a.value_time || a.value_int || a.value_decimal || 999999;
                const bVal = b.value_time || b.value_int || b.value_decimal || 999999;
                return aVal - bVal;
            });

            if (score) {
                const rank = filteredWodScores.findIndex(s => s.id === score.id) + 1;
                participantScores[wod.id] = { rank, score };
                totalPoints += rank;
            } else {
                const worstPlace = filteredWodScores.length;
                participantScores[wod.id] = { rank: worstPlace + 1, score: null };
                totalPoints += worstPlace + 1;
            }
        });

        rankings.push({
            participant,
            wodScores: participantScores,
            totalPoints
        });
    });

    rankings.sort((a, b) => a.totalPoints - b.totalPoints);
    return rankings;
}

// Render
function render() {
    if (currentWod === 'overall') {
        renderOverall();
    } else {
        renderSingleWod(parseInt(currentWod));
    }
}

// Render overall leaderboard
function renderOverall() {
    document.getElementById('leaderboard-title').textContent = 'Classement G√©n√©ral';
    document.getElementById('leaderboard-subtitle').textContent = 'Moins de points = Meilleur classement';

    const rankings = calculateRankings();
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('leaderboard-tbody');

    // Headers
    headerRow.innerHTML = `
        <th class="text-left py-3 px-4 font-semibold text-gray-700">Rang</th>
        <th class="text-left py-3 px-4 font-semibold text-gray-700">Participant</th>
        <th class="text-center py-3 px-4 font-semibold text-gray-700 hidden md:table-cell">Cat√©gorie</th>
        ${wods.map(w => `<th class="text-center py-3 px-2 font-semibold text-gray-700 hidden md:table-cell">WOD ${w.wod_number}</th>`).join('')}
        <th class="text-center py-3 px-4 font-semibold text-gray-700">Total</th>
    `;

    if (rankings.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${3 + wods.length + 1}" class="text-center py-8 text-gray-500">Aucun r√©sultat</td></tr>`;
        return;
    }

    tbody.innerHTML = rankings.map((r, index) => {
        const rank = index + 1;
        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';

        const wodCells = wods.map(w => {
            const place = r.wodScores[w.id]?.rank || '-';
            return `<td class="py-3 px-2 text-center font-mono text-sm hidden md:table-cell">${place}</td>`;
        }).join('');

        return `
            <tr class="border-b border-gray-200 hover:bg-gray-50 ${rankClass}">
                <td class="py-3 px-4 font-bold text-lg">${rank}</td>
                <td class="py-3 px-4 font-semibold">${r.participant.name}</td>
                <td class="py-3 px-4 text-center hidden md:table-cell">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${
                        r.participant.level === 'RX' ? 'bg-blue-100 text-blue-800' :
                        r.participant.level === 'INTER' ? 'bg-green-100 text-green-800' :
                        'bg-gray-100 text-gray-800'
                    }">${r.participant.level}</span>
                </td>
                ${wodCells}
                <td class="py-3 px-4 text-center font-bold text-xl">${r.totalPoints}</td>
            </tr>
        `;
    }).join('');
}

// Render single WOD leaderboard
function renderSingleWod(wodId) {
    const wod = wods.find(w => w.id === wodId);
    if (!wod) return;

    document.getElementById('leaderboard-title').textContent = `WOD ${wod.wod_number}`;
    document.getElementById('leaderboard-subtitle').textContent = wod.description || '';

    const filtered = filterParticipants(participants);
    const wodScores = scores.filter(s => s.workout_id === wodId);

    const results = filtered.map(p => {
        const score = wodScores.find(s => {
            if (p.type === 'team') return s.team_id === p.teamId;
            return s.athlete_id === p.athleteId;
        });
        return { participant: p, score };
    }).filter(r => r.score);

    results.sort((a, b) => {
        const aVal = a.score.value_time || a.score.value_int || a.score.value_decimal || 999999;
        const bVal = b.score.value_time || b.score.value_int || b.score.value_decimal || 999999;
        return aVal - bVal;
    });

    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('leaderboard-tbody');

    headerRow.innerHTML = `
        <th class="text-left py-3 px-4 font-semibold text-gray-700">Rang</th>
        <th class="text-left py-3 px-4 font-semibold text-gray-700">Participant</th>
        <th class="text-center py-3 px-4 font-semibold text-gray-700 hidden md:table-cell">Cat√©gorie</th>
        <th class="text-center py-3 px-4 font-semibold text-gray-700">R√©sultat</th>
        <th class="text-center py-3 px-4 font-semibold text-gray-700">Points</th>
    `;

    if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Aucun r√©sultat</td></tr>';
        return;
    }

    tbody.innerHTML = results.map((r, index) => {
        const rank = index + 1;
        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
        const result = r.score.value_time || r.score.value_int || r.score.value_decimal || '-';

        return `
            <tr class="border-b border-gray-200 hover:bg-gray-50 ${rankClass}">
                <td class="py-3 px-4 font-bold text-lg">${rank}</td>
                <td class="py-3 px-4 font-semibold">${r.participant.name}</td>
                <td class="py-3 px-4 text-center hidden md:table-cell">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${
                        r.participant.level === 'RX' ? 'bg-blue-100 text-blue-800' :
                        r.participant.level === 'INTER' ? 'bg-green-100 text-green-800' :
                        'bg-gray-100 text-gray-800'
                    }">${r.participant.level}</span>
                </td>
                <td class="py-3 px-4 text-center font-mono">${result}</td>
                <td class="py-3 px-4 text-center font-bold text-xl">${rank}</td>
            </tr>
        `;
    }).join('');
}

function updateLastUpdate() {
    const now = new Date();
    const time = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('last-update').textContent = time;
}

function startAutoRefresh() {
    setInterval(async () => {
        await loadTournamentData();
    }, 10000);
}

init();
</script>

</body>
</html>
